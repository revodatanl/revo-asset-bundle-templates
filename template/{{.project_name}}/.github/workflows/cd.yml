name: Deploy Databricks Asset Bundle

# Before using this pipeline:
# 1. Update variables: groupName, environmentName, keyVaultName, azureSubscription
# 2. Create Library Groups in Azure DevOps: {groupName}_test and {groupName}_prod; store DATABRICKS_HOST
# 3. Create Environments in Azure DevOps: {environmentName}_test and {environmentName}_prod
# 4. Add approvers to {environmentName}_prod environment
# 5. Store secrets in Azure Key Vault: DATABRICKS_CLIENT_ID, DATABRICKS_CLIENT_SECRET

on:
  workflow_run:
    workflows:
      - Semantic Release
    types:
      - completed

permissions:
  contents: read

jobs:
  deploy_test:
    name: Deploy to test
    runs-on: ubuntu-latest
    environment: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to test
        uses: ./.github/actions/cd
        with:
          target: test
          databricks_host: ${{ secrets.DATABRICKS_HOST }}
          databricks_client_id: ${{ secrets.DATABRICKS_CLIENT_ID }}
          databricks_client_secret: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

  deploy_prod:
    name: Deploy to production
    needs: deploy_test
    runs-on: ubuntu-latest
    environment: prod
    if: needs.deploy_test.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to production
        uses: ./.github/actions/cd
        with:
          target: prod
          databricks_host: ${{ secrets.DATABRICKS_HOST }}
          databricks_client_id: ${{ secrets.DATABRICKS_CLIENT_ID }}
          databricks_client_secret: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
