name: CI DABs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  ci-dabs:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Default configurations
          - os: ubuntu-latest
            cicd_provider: github
            cloud_provider: azure
            include_example_jobs: yes
            catalog_name: ""
            use_devcontainer: no
            use_databricks_connect: no
          - os: macos-latest
            cicd_provider: github
            cloud_provider: azure
            include_example_jobs: yes
            catalog_name: ""
            use_devcontainer: no
            use_databricks_connect: no
          # Non-default configuration
          - os: ubuntu-latest
            cicd_provider: azure
            cloud_provider: aws
            include_example_jobs: no
            catalog_name: ""
            use_devcontainer: no
            use_databricks_connect: yes
          - os: macos-latest
            cicd_provider: azure
            cloud_provider: aws
            include_example_jobs: no
            catalog_name: ""
            use_devcontainer: no
            use_databricks_connect: yes
          # DevContainer configurations
          - os: ubuntu-latest
            cicd_provider: github
            cloud_provider: azure
            include_example_jobs: yes
            catalog_name: ""
            use_devcontainer: yes
            use_databricks_connect: no
            container_name: revo-devcontainer-databricksruntime
            container_tag: "15.4-LTS"
          - os: ubuntu-latest
            cicd_provider: azure
            cloud_provider: aws
            include_example_jobs: no
            catalog_name: ""
            use_devcontainer: yes
            use_databricks_connect: yes
            container_name: revo-devcontainer-databricksruntime
            container_tag: "15.4-LTS"

    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      CONTAINER_REGISTRY: ghcr.io
      CONTAINER_NAME: ${{ matrix.container_name || '' }}
      CONTAINER_TAG: ${{ matrix.container_tag || '' }}

    steps:
      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo sh
          databricks version

      - name: Create init parameters JSON
        run: |
          cat > init_params.json << EOF
          {
            "project_name": "revo-dabs-test-project",
            "package_name": "revo_dabs",
            "author": "Thomas Brouwer",
            "email": "thomas.brouwer@revodata.nl",
            "project_description": "This project is generated using our own RevoData Asset Bundle Templates.",
            "cicd_provider": "${{ matrix.cicd_provider }}",
            "cloud_provider": "${{ matrix.cloud_provider }}",
            "include_example_jobs": "${{ matrix.include_example_jobs }}",
            "catalog_name": "${{ matrix.catalog_name }}",
            "use_devcontainer": "${{ matrix.use_devcontainer }}",
            "use_databricks_connect": "${{ matrix.use_databricks_connect }}"
          }
          EOF
          cat init_params.json

      - name: Initialize Databricks Asset Bundle from template
        run: |
          echo "Using branch: $BRANCH_NAME"
          databricks bundle init https://github.com/revodatanl/revo-asset-bundle-templates --branch $BRANCH_NAME --config-file init_params.json
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

      - name: Build and test Databricks Asset Bundle with Makefile
        if: matrix.use_devcontainer == 'no'
        run: |
          cd revo-dabs-test-project
          echo ""
          echo "=================================================================="
          echo "=============== BUILD PROJECT (WITH DEFAULT TARGET) =============="
          echo "=================================================================="
          make

          echo ""
          echo "=================================================================="
          echo "=============== RE-INSTALL DEPENDENCIES ========================="
          echo "=================================================================="
          make install

          echo ""
          echo "=================================================================="
          echo "=============== RE-BUILD PROJECT (WITH SETUP TARGET) ============="
          echo "=================================================================="
          make setup

          echo ""
          echo "=================================================================="
          echo "==================== COMMIT ALL FILES ============================"
          echo "=================================================================="
          uv run pre-commit autoupdate || true
          git config --global user.email "pipeline@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "feat: initial commit"

          echo ""
          echo "=================================================================="
          echo "======================== GENERATE TREE ==========================="
          echo "=================================================================="
          make tree

          echo ""
          echo "=================================================================="
          echo "======================== LINT PROJECT ============================"
          echo "=================================================================="
          make lint

          echo ""
          echo "=================================================================="
          echo "========================= RUN TESTS =============================="
          echo "=================================================================="
          make test

          echo ""
          echo "=================================================================="
          echo "======================== GENERATE DOCS ==========================="
          echo "=================================================================="
          uv run mkdocs build

          echo ""
          echo "=================================================================="
          echo "======================== CLEAN PROJECT ==========================="
          echo "=================================================================="
          make clean

          echo ""
          echo "=================================================================="
          echo "=========== RE-BUILD PROJECT (AFTER CLEAN) ======================="
          echo "=================================================================="
          make

          echo ""
          echo "=================================================================="
          echo "======================== VALIDATE BUNDLE ========================="
          echo "=================================================================="
          databricks bundle validate
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

      - name: Log in to GitHub Container Registry
        if: matrix.use_devcontainer == 'yes'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull DevContainer image
        if: matrix.use_devcontainer == 'yes'
        run: |
          echo "Pulling container image..."
          docker pull ${{ env.CONTAINER_REGISTRY }}/${{ github.repository_owner }}/${{ env.CONTAINER_NAME }}:${{ env.CONTAINER_TAG }}

      # Mount the project directory and run Make commands inside the container
      - name: Build and test Databricks Asset Bundle with Makefile in container
        if: matrix.use_devcontainer == 'yes'
        run: |
          cd revo-dabs-test-project
          echo "Running commands in container..."
          cat Makefile
          cat pyproject.toml
          set -e
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -e DATABRICKS_HOST="${{ secrets.DATABRICKS_HOST }}" \
            -e DATABRICKS_CLIENT_ID="${{ secrets.DATABRICKS_CLIENT_ID }}" \
            -e DATABRICKS_CLIENT_SECRET="${{ secrets.DATABRICKS_CLIENT_SECRET }}" \
            -e PATH="/databricks/python3/bin:$PATH" \
            -e UV_PROJECT_ENVIRONMENT="/databricks/python3" \
            -e UV_SYSTEM_PYTHON=true \
            -w /workspace/revo-dabs-test-project \
            ${{ env.CONTAINER_REGISTRY }}/${{ github.repository_owner }}/${{ env.CONTAINER_NAME }}:${{ env.CONTAINER_TAG }} \
            bash -c "
              set -e
              cd /workspace/revo-dabs-test-project

              echo \"Setting Git configuration...\"
              git config --global user.email \"pipeline@github.com\"
              git config --global user.name \"GitHub Actions\"

              echo \"Adding workspace to Git safe.directory to fix ownership issues...\"
              git config --global --add safe.directory /workspace/revo-dabs-test-project
              git config --global --add safe.directory '*'

              echo \"\"
              echo \"==================================================================\"
              echo \"=============== BUILD PROJECT (WITH DEFAULT TARGET) ==============\"
              echo \"==================================================================\"
              make

              echo \"\"
              echo \"==================================================================\"
              echo \"================ SETUP PROJECT (WITH SETUP TARGET) ===============\"
              echo \"==================================================================\"
              make setup

              echo \"\"
              echo \"==================================================================\"
              echo \"=============== BUILD PROJECT (WITH BUILD TARGET) ================\"
              echo \"==================================================================\"
              make build

              echo \"\"
              echo \"==================================================================\"
              echo \"==================== COMMIT ALL FILES ============================\"
              echo \"==================================================================\"
              uv run pre-commit autoupdate || true
              git add .
              git commit -m \"feat: initial commit\"

              echo \"\"
              echo \"==================================================================\"
              echo \"======================== GENERATE TREE ===========================\"
              echo \"==================================================================\"
              make tree

              echo \"\"
              echo \"==================================================================\"
              echo \"======================== LINT PROJECT ============================\"
              echo \"==================================================================\"
              make lint

              echo \"\"
              echo \"==================================================================\"
              echo \"========================= RUN TESTS ==============================\"
              echo \"==================================================================\"
              make test

              echo \"\"
              echo \"==================================================================\"
              echo \"======================== GENERATE DOCS ===========================\"
              echo \"==================================================================\"
              uv run mkdocs build

              echo \"\"
              echo \"==================================================================\"
              echo \"======================== CLEAN PROJECT ===========================\"
              echo \"==================================================================\"
              make clean

              echo \"\"
              echo \"==================================================================\"
              echo \"=============== RE-BUILD PROJECT (AFTER CLEAN) ===================\"
              echo \"==================================================================\"
              make build

              echo \"\"
              echo \"==================================================================\"
              echo \"======================== VALIDATE BUNDLE =========================\"
              echo \"==================================================================\"
              databricks bundle validate

              # Exit with status code from the last command
              exit \$?
            "

          # Capture Docker exit status
          DOCKER_EXIT_CODE=$?
          if [ $DOCKER_EXIT_CODE -ne 0 ]; then
            echo "Container commands failed with exit code: $DOCKER_EXIT_CODE"
            exit $DOCKER_EXIT_CODE
          fi
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

      - name: Deploy Databricks Asset Bundle (using default runner only)
        if: |
          matrix.os == 'ubuntu-latest' &&
          matrix.cicd_provider == 'github' &&
          matrix.cloud_provider == 'azure' &&
          matrix.include_example_jobs == 'yes' &&
          matrix.use_devcontainer == 'no'  &&
          matrix.use_databricks_connect == 'no'
        run: |
          cd revo-dabs-test-project
          echo ""
          echo "=================================================================="
          echo "======================== DEPLOY BUNDLE ==========================="
          echo "=================================================================="
          databricks bundle deploy
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}

      - name: Upload project artifact
        if: |
          matrix.os == 'ubuntu-latest' &&
          matrix.cicd_provider == 'github' &&
          matrix.cloud_provider == 'azure' &&
          matrix.include_example_jobs == 'yes' &&
          matrix.use_devcontainer == 'no' &&
          matrix.use_databricks_connect == 'no'
        uses: actions/upload-artifact@v4
        with:
          name: revo-dabs-test-project
          path: revo-dabs-test-project
          retention-days: 1


# Run example workflow in parallel with the example DLT pipeline workflow
  run-example-workflow:
    needs: ci-dabs
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: revo-dabs-test-project
          path: revo-dabs-test-project

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo sh
          databricks version

      - name: Run Example Workflow
        run: |
          cd revo-dabs-test-project
          echo ""
          echo "=================================================================="
          echo "==================== RUN EXAMPLE WORKFLOW ========================"
          echo "=================================================================="
          echo "Starting 'example-workflow'... (this may take a while)"
          EXAMPLE_WORKFLOW_ID=$(databricks jobs list --output json | jq '.[] | select(.settings.name | contains("example-workflow")) | .job_id')
          echo "Example workflow ID: $EXAMPLE_WORKFLOW_ID"

          if [ -z "$EXAMPLE_WORKFLOW_ID" ]; then
            echo "Error: Could not find example-workflow"
            databricks jobs list --output text
            exit 1
          fi

          RESULT_STATE=$(databricks jobs run-now $EXAMPLE_WORKFLOW_ID | jq -r '.state.result_state')
          echo "Workflow result state: $RESULT_STATE"

          if [[ "$RESULT_STATE" == "SUCCESS" ]]; then
            echo "Workflow completed successfully!"
          else
            echo "Workflow failed with status: $RESULT_STATE"
            exit 1
          fi
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}


# Run example DLT pipeline workflow in parallel with the example workflow
  run-example-dlt-workflow:
    needs: ci-dabs
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: revo-dabs-test-project
          path: revo-dabs-test-project

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo sh
          databricks version

      - name: Run example DLT pipeline workflow
        run: |
          cd revo-dabs-test-project
          echo ""
          echo "=================================================================="
          echo "=============== RUN EXAMPLE DLT PIPELINE WORKFLOW ================"
          echo "=================================================================="
          echo "Starting 'demo_dlt_pipeline_workflow'... (this may take a while)"
          DLT_PIPELINE_WORKFLOW_ID=$(databricks jobs list --output json | jq '.[] | select(.settings.name | contains("demo_dlt_pipeline_workflow")) | .job_id')
          echo "Example DLT pipeline ID: $DLT_PIPELINE_WORKFLOW_ID"

          if [ -z "$DLT_PIPELINE_WORKFLOW_ID" ]; then
            echo "Error: Could not find demo_dlt_pipeline_workflow"
            databricks jobs list --output text
            exit 1
          fi

          DLT_PIPELINE_RESULT_STATE=$(databricks jobs run-now $DLT_PIPELINE_WORKFLOW_ID | jq -r '.state.result_state')
          echo "DLT pipeline result state: $DLT_PIPELINE_RESULT_STATE"

          if [[ "$DLT_PIPELINE_RESULT_STATE" == "SUCCESS" ]]; then
            echo "DLT pipeline completed successfully!"
          else
            echo "DLT pipeline failed with status: $DLT_PIPELINE_RESULT_STATE"
            exit 1
          fi
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}


# Destroy bundle regardless of the outcome of the other workflows
  destroy-bundle:
    needs: [run-example-workflow, run-example-dlt-workflow]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download project artifact
        uses: actions/download-artifact@v4
        with:
          name: revo-dabs-test-project
          path: revo-dabs-test-project

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sudo sh
          databricks version

      - name: Destroy Bundle
        run: |
          cd revo-dabs-test-project
          echo ""
          echo "=================================================================="
          echo "======================== DESTROY BUNDLE =========================="
          echo "=================================================================="
          databricks bundle destroy --auto-approve
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
